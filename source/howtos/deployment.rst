Blockchain network deployment
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

This guide demonstrates how to deploy your own blockchain network.
    
    .. note::
    
        * If you want to try the Apla blockchain network instead, check out `Apla Testnet <https://testapla0.apla.io/>`_.

        * If you want to deploy a local testing environment quickly, consider using `Apla quickstart <https://github.com/AplaProject/quick-start>`_ which is based on Docker images.


.. _deployment-config:

Example deployment
##################

This guide deploys the example blockchain network of three nodes. 

The network has three nodes: 

    - Node 1 is the first node in the blockchain network. It can generate new blocks and send transactions from the clients connected to it.

    - Node 2 is an extra validating node. It can generate new blocks and send transactions from the clients connected to it.
    
    - Node 3 is an extra node. It cannot generate new blocks but can send transactions from the clients connected to it. 

Nodes are deployed in this configuration: 

    - Each node will use its own instance of PostgreSQL database system.

    - Each node will use its own instance of Centrifugo service.

    - The go-apla services will be deployed on the same host with other backend components.


Addresses and ports used by nodes are described in the following table:

.. list-table::
   :header-rows: 1
   :widths: auto

   * - Node
     - Component
     - IP and Port
   * - 1
     - PostgreSQL
     - 127.0.0.1:5432
   * - 1
     - Centrifugo
     - 10.10.99.1:8000
   * - 1
     - go-apla (TCP-server)
     - 10.10.99.1:7078
   * - 1
     - go-apla (API-server)
     - 10.10.99.1:7079
   * - 2
     - PostgreSQL
     - 127.0.0.1:5432
   * - 2
     - Centrifugo
     - 10.10.99.2:8000
   * - 2
     - go-apla (TCP-server)
     - 10.10.99.2:7078
   * - 2
     - go-apla (API-server)
     - 10.10.99.2:7079
   * - 3
     - PostgreSQL
     - 127.0.0.1:5432
   * - 3
     - Centrifugo
     - 10.10.99.3:8000
   * - 3
     - go-apla (TCP-server)
     - 10.10.99.3:7078
   * - 3
     - go-apla (API-server)
     - 10.10.99.3:7079


Deployment stages
#################

Your own blockchain network must be deployed in several stages:

1. :ref:`Backend deployment <deployment-backend>`

    1. :ref:`Deploying the first node <deployment-first-node>`
    2. :ref:`Deploying additional nodes <deployment-additional-nodes>`

2. :ref:`Frontend deployment <deployment-frontend>`

3. :ref:`Blockchain network configuration <deployment-blockchain-config>`

    1. :ref:`Creating the founder's account <deployment-founder>`
    2. :ref:`Importing apps, roles, and templates <deployment-import>`
    3. :ref:`Adding first node to the list of nodes <deployment-full-nodes-first>`

4. :ref:`Adding extra validating nodes <deployment-full-nodes-extra>`

    1. :ref:`Adding a member to Consensus role <deployment-consensus-member>`
    2. :ref:`Creating the node owner's account <deployment-validator-account>`
    3. :ref:`Adding node owner to Validators role <deployment-validator-voting>`
    4. :ref:`Adding the validating node via voting <deployment-validator-node>`


.. _deployment-backend:

Backend deployment
##################

.. _deployment-first-node:

Deploying the first node
========================

First node is a special node because it must be used to start the blockchain network. First block of the blockchain is generated by the first node and all other nodes download the blockchain from it. The owner of the first node becomes the platform *founder*.


.. _dependencies:

Dependencies and environment setup
----------------------------------

sudo
""""

All commands for Debian 9 must be run as a non-root user. But some system commands need superuser privileges to be executed. By default, sudo is not installed on Debian 9, and you must install it first.

1) Become the root superuser.

.. code-block:: bash

    su -


2) Upgrade your system.

.. code-block:: bash
    
    apt update -y && apt upgrade -y && apt dist-upgrade -y

3) Install sudo.

.. code-block:: bash

    apt install sudo -y


4) Add your user to the sudo group.

.. code-block:: bash
    
    usermod -a -G sudo user

5) After the reboot, the changes take effect.


Go language
"""""""""""

Install Go as described in the `official documentation <https://golang.org/doc/install#tarball>`_.


1) Download the latest stable version of Go (1.11.2) from the `Golang official site <https://golang.org/dl/>`_ or via the command line:

.. code-block:: bash

    wget https://dl.google.com/go/go1.11.2.linux-amd64.tar.gz

2) Extract the package to ``/usr/local``.

.. code-block:: bash

    tar -C /usr/local -xzf go1.11.2.linux-amd64.tar.gz


3) Add ``/usr/local/go/bin`` to the PATH environment variable (either to ``/etc/profile`` or ``$HOME/.profile``).

.. code-block:: bash

    export PATH=$PATH:/usr/local/go/bin


4) For changes to take effect, ``source`` this file. For example:

.. code-block:: bash
    
    source $HOME/.profile


5) Remove the temporary file:

.. code-block:: bash

    rm go1.11.2.linux-amd64.tar.gz


PostgreSQL
""""""""""

1) Install PostgreSQL and psql:

.. code-block:: bash

    sudo apt install -y postgresql


Centrifugo
""""""""""

1) Download Centrifugo version 1.7.9 `from GitHub <https://github.com/centrifugal/centrifugo/releases/>`_ or via command line:


.. code-block:: bash

    wget https://github.com/centrifugal/centrifugo/releases/download/v1.7.9/centrifugo-1.7.9-linux-amd64.zip \
    && unzip centrifugo-1.7.9-linux-amd64.zip \
    && mkdir centrifugo \
    && mv centrifugo-1.7.9-linux-amd64/* centrifugo/


2) Remove temporary files:

.. code-block:: bash

    rm -R centrifugo-1.7.9-linux-amd64 \
    && rm centrifugo-1.7.9-linux-amd64.zip


Directories
"""""""""""

For Debian 9 OS, it is recommended to store all software used by the blockchain platform in a separate directory.

This guide uses the ``/opt/apla`` directory, but you can use any directory. In this case, change all commands and configuration files accordingly.

1) Make a directory for the blockchain platform:

.. code-block:: bash

    sudo mkdir /opt/apla

2) Make your user the owner of this directory:

.. code-block:: bash

    sudo chown user /opt/apla/

3) Make subdirectories for Centrifugo, go-apla, and node data. In this guide, all node data is stored in the directories with ``nodeX`` name, where ``X`` is the node number. Depending on which node you are deploying, this will be ``node1`` for node 1, ``node2`` for node 2, and so on.

.. code-block:: bash

    mkdir /opt/apla/go-apla \
    mkdir /opt/apla/go-apla/node1 \
    mkdir /opt/apla/centrifugo \


.. _database:

Creating the database
---------------------

1) Change user's password postgres to Apla's default password. You can set your own password, but then you must change it in the node configuration file config.toml.

.. code-block:: bash

    sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'apla'"


2) Create a node current state database, for example 'apladb':

.. code-block:: bash

    sudo -u postgres psql -c "CREATE DATABASE apladb"

.. _centrifugo:

Configuring Centrifugo
----------------------

1) Create Centrifugo configuration file:

.. code-block:: bash

    echo '{"secret":"CENT_SECRET"}' > /opt/apla/centrifugo/config.json

You can set your own "secret", but then you also must change it in the node configuration file config.toml.

.. _go-apla-install:

Installing go-apla
------------------

1) Download and build the `latest release of go-apla <https://github.com/AplaProject/go-apla/releases>`_ from GitHub:

.. code-block:: bash

    go get -v github.com/AplaProject/go-apla

2) Copy the go-apla binary to the ``/opt/apla/go-apla`` directory. If you use the `default Go workspace <https://golang.org/doc/code.html#Workspaces>`_ then the binary is located in the ``$HOME/go/bin`` directory:

.. code-block:: bash

    cp $HOME/go/bin/go-apla /opt/apla/go-apla


Configuring the first node
--------------------------

1) Create the node 1 configuration file:

.. code-block:: bash

    /opt/apla/go-apla/go-apla config \
        --dataDir=/opt/apla/go-apla/node1 \
        --dbName=apladb \
        --centSecret="CENT_SECRET" --centUrl=http://10.10.99.1:8000 \
        --httpHost=10.10.99.1 \
        --httpPort=7079 \
        --tcpHost=10.10.99.1 \
        --tcpPort=7078

4) Generate node 1 keys:

.. code-block:: bash

    /opt/apla/go-apla/go-apla generateKeys \
        --config=/opt/apla/go-apla/node1/config.toml

5) Generate the first block:

.. note:: 
    
    If you are creating your own blockchain network. you must use the ``--test=true`` option. Otherwise you will not be able to create new accounts.

.. code-block:: bash

    /opt/apla/go-apla/go-apla generateFirstBlock \
        --config=/opt/apla/go-apla/node1/config.toml \
        --test=true

6) Initialize the database:

.. code-block:: bash

    /opt/apla/go-apla/go-apla initDatabase \
        --config=/opt/apla/go-apla/node1/config.toml


Starting the first node backend
-------------------------------

.. _services: https://wiki.debian.org/systemd/Services

To start the first node backend, you must start two services:

-   centrifugo
-   go-apla

If you did not create these as `services`_, you can just execute binary files from their directories in different consoles.

1) Run centrifugo:

.. code-block:: bash

    /opt/apla/centrifugo/centrifugo \
        -a 10.10.99.1 -p 8000 \
        --config /opt/apla/centrifugo/config.json


2) Run go-apla:

.. code-block:: bash

    /opt/apla/go-apla/go-apla start \
        --config=/opt/apla/go-apla/node1/config.toml


.. _deployment-additional-nodes:

Deploying additional nodes
==========================

All other nodes (Node 2 and Node 3) are deployed like the first node with three differences:

- You do not need to generate the first block. Instead, it must be copied to the node data directory from node 1.
- The node must be configured to download blocks from node 1 via ``--nodesAddr`` option.
- The node must be configured to use its own addresses and ports.

Node 2
------

Follow this sequence of actions:

    1. :ref:`dependencies`

    2. :ref:`database`

    3. :ref:`centrifugo`

    4. :ref:`go-apla-install`

    5. Create the node 2 configuration file:

        .. code-block:: bash

            /opt/apla/go-apla/go-apla config \
                --dataDir=/opt/apla/go-apla/node2 \
                --dbName=apladb \
                --centSecret="CENT_SECRET" --centUrl=http://10.10.99.2:8000 \
                --httpHost=10.10.99.2 \
                --httpPort=7079 \
                --tcpHost=10.10.99.2 \
                --tcpPort=7078 \
                --nodesAddr=10.10.99.1

    6. Copy the first block file to Node 2. For example, you can do it via ``scp`` on Node 2:

        .. code-block:: bash
            
            scp user@10.10.99.1:/opt/apla/go-apla/node1/1block /opt/apla/go-apla/node2/


    7. Generate node 2 keys:

        .. code-block:: bash

            /opt/apla/go-apla/go-apla generateKeys \
                --config=/opt/apla/go-apla/node2/config.toml

    8. Initialize the database:

        .. code-block:: bash
        
            ./go-apla initDatabase --config=node2/config.toml

    9. Run centrifugo:

        .. code-block:: bash

            /opt/apla/centrifugo/centrifugo \
                -a 10.10.99.2 -p 8000 \
                --config /opt/apla/centrifugo/config.json

    10. Run go-apla:

        .. code-block:: bash

            /opt/apla/go-apla/go-apla start \
                --config=/opt/apla/go-apla/node2/config.toml


As a result, the node will download the blocks from the first node. This node is not the validating node, so it cannot generate new blocks. Node 2 will be added to the list of validating nodes later in this guide.


Node 3
------

Follow this sequence of actions:

    1. :ref:`dependencies`

    2. :ref:`database`

    3. :ref:`centrifugo`

    4. :ref:`go-apla-install`

    5. Create the node 3 configuration file:

        .. code-block:: bash

            /opt/apla/go-apla/go-apla config \
                --dataDir=/opt/apla/go-apla/node3 \
                --dbName=apladb \
                --centSecret="CENT_SECRET" --centUrl=http://10.10.99.3:8000 \
                --httpHost=10.10.99.3 \
                --httpPort=7079 \
                --tcpHost=10.10.99.3 \
                --tcpPort=7078 \
                --nodesAddr=10.10.99.1

    6. Copy the first block file to Node 3. For example, you can do it via ``scp`` on Node 3:

        .. code-block:: bash
            
            scp user@10.10.99.1:/opt/apla/go-apla/node1/1block /opt/apla/go-apla/node3/


    7. Generate node 3 keys:

        .. code-block:: bash

            /opt/apla/go-apla/go-apla generateKeys \
                --config=/opt/apla/go-apla/node3/config.toml

    8. Initialize the database:

        .. code-block:: bash
        
            ./go-apla initDatabase --config=node3/config.toml

    9. Run centrifugo:

        .. code-block:: bash

            /opt/apla/centrifugo/centrifugo \
                -a 10.10.99.3 -p 8000 \
                --config /opt/apla/centrifugo/config.json

    10. Run go-apla:

        .. code-block:: bash

            /opt/apla/go-apla/go-apla start \
                --config=/opt/apla/go-apla/node3/config.toml

As a result, the node will download the blocks from the first node. This node is not the validating node, so it cannot generate new blocks. Ð¡lients can connect to this node and it can send transactions to the network.


.. _deployment-frontend:

Frontend deployment
###################

Molis client can be build by the yarn package manager only on Debian 9 (Stretch) 64-bit `official distributive <https://www.debian.org/CD/http-ftp/#stable>`_ with **installed GNOME GUI**.


Software prerequisites
======================

Node.js
-------

1) Download Node.js LTS version 8.11 from the `Node.js official site <https://nodejs.org/en/download/>`_ or via the command line:

.. code-block:: bash

    curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash


2) Install Node.js:

.. code-block:: bash

    sudo apt install -y nodejs


Yarn
----

1) Download Yarn version 1.7.0 from `yarn GitHub repository <https://github.com/yarnpkg/yarn/releases>`_ or via command line:

.. code-block:: bash

    cd /opt/apla \
    && wget https://github.com/yarnpkg/yarn/releases/download/v1.7.0/yarn_1.7.0_all.deb

2) Install Yarn:

.. code-block:: bash

    sudo dpkg -i yarn_1.7.0_all.deb && rm yarn_1.7.0_all.deb


Building Molis App
==================

1) Download latest release of Molis from `Molis GitHub repository <https://github.com/AplaProject/apla-front/releases>`_ via git:

.. code-block:: bash

    cd /opt/apla \
    && git clone https://github.com/AplaProject/apla-front.git

2) Install Molis dependencies via Yarn:

.. code-block:: bash

    cd /opt/apla/apla-front/ \
    && yarn install


.. _front-connections:

Adding the blockchain network configuration
-------------------------------------------

1) Create settings.json file that contains connections information about full nodes:

.. code-block:: bash

    cp /opt/apla/apla-front/public/settings.json.dist \
        /opt/apla/apla-front/public/public/settings.json

2) Edit settings.json file in any text editor and add required settings in this format:

.. code-block:: text

    http://Node_IP-address:Node_HTTP-Port


**Example** settings.json file for three nodes:

.. code-block:: json

    {
        "fullNodes": [
            "http://10.10.99.1:7079",
            "http://10.10.99.2:7079",
            "http://10.10.99.3:7079"
        ]
    }


Building as Molis Desktop App
-----------------------------

1) Build the desktop app with Yarn:

.. code-block:: bash
    
    cd /opt/apla/apla-front \
    && yarn build-desktop

2) The desktop app must be packed to the AppImage:

.. code-block:: bash

    yarn release --publish never -l


After that, your application will be ready to use, but its :ref:`connection settings <front-connections>` cannot be changed in the future. If these settings will change, you must build a new version of the application.


Building as Molis Web App
-------------------------

1) Build the web app:

.. code-block:: bash
    
    cd /opt/apla/apla-front/ \
    && yarn build


After building, redistributable files will be placed to the '/build' directory. You can serve it with any web-server of your choice. Settings.json file must be also placed there. Note that you do not need to build your application again if your connection settings will change. Instead, edit the settings.json file and restart web-server.

2) For development or testing purposes, you can build Yarn's web-server:

.. code-block:: bash

    sudo yarn global add serve \
    && serve -s build

After this, your Molis Web App will be available at: ``http://localhost:5000``


.. _deployment-blockchain-config:

Blockchain network configuration
################################

.. _deployment-founder:

Creating the founder's account
==============================

Create an account for the first node owner. This account is the founder of the new blockchain platform and will have administrator access rights.

1) Run Molis (frontend).

2) Import an existing account using the following data:

    - Backup payload is the node owner's private key located in the ``/opt/apla/go-apla/node1/PrivateKey`` file.

        .. note::

            There are two private key files in this directory. ``PrivateKey`` file is for node owner's account. It is used to create the node owner's account. ``NodePrivateKey`` is the private key of the node itself and must be kept secret.

3) Login under this new account. Because roles haven't been created at this moment, use the *Without role* login option.


.. _deployment-import:

Importing apps, roles, and templates
====================================

At this moment, the blockchain platform is in the blank state. You can configure it by adding the framework of roles, templates and apps that support the basic ecosystem functions.

1) Clone the applications repository.

.. code-block:: bash

    cd /opt/apla \
    && git clone https://github.com/AplaProject/apps.git

2) In Molis, navigate to *Developer* > *Import*.

3) Import apps in this order:

    A. /opt/apla/apps/system.json
    B. /opt/apla/apps/lang_res.json
    C. /opt/apla/apps/basic.json
    D. /opt/apla/apps/conditions.json

4) Navigate to *Admin* > *Roles* and click *Install default roles*.

5) Sign out of the system via the profile menu.

6) Log into the system under the *Admin* role.

7) Navigate to *Home* > *Votings* > *Templates list* and click *Install default templates*.

.. _deployment-full-nodes-first:

Adding first node to the list of nodes
======================================


1) Navigate to *Admin* > *Platform parameters* and click the cogwheel icon for the *full_nodes* parameter.

2) Specify the parameters for the first blockchain network node. Node's public key is located in the ``/opt/apla/go-apla/node1/NodePublicKey`` file. Node owner's key identifier is located in the ``/opt/apla/go-apla/node1/KeyID`` file.

.. code-block:: json

    {"api_address":"http://10.10.99.1:7079","key_id":"%node_owner_key_id%","public_key":"%node_public_key%","tcp_address":"10.10.99.1:7078"}


.. _deployment-full-nodes-extra:

Adding extra validating nodes
#############################

.. _deployment-consensus-member:

Adding a member to Consensus role
=================================

By default, only members of the Consensus role (Apla Consensus asbl) can participate in votings required for adding extra validating nodes. It means that a member of the ecosystem must be appointed to this role before new validating nodes can be added. 

In this guide, the founder's account will be appointed as a sole member of the Consensus. In a production environment, this role must be assigned to members that perform platform governance.

1) As an ecosystem founder, navigate to *Home* > *Roles* and click the Consensus role (Apla Consensus asbl).

2) Click *Assign* and assign founder's account to this role.


.. _deployment-validator-account:

Creating the node owner's account
=================================

1) Run Molis (frontend)

2) Import an existing account using the following data:

    - Backup payload is the node owner's private key located in the ``/opt/apla/go-apla/node2/PrivateKey`` file.

3) Login under this new account. Because a role hasn't been assigned to this account, use the *Without role* login option.

4) Navigate to *Home* > *Profile* and click on the new profile name.

5) Add account details (profile name, description, etc.)


.. _deployment-validator-voting:

Adding node owner to Validator role
===================================

1) As a new node owner:

    A. Navigate to *Home* > *Candidates for the validators*.

    B. Click *Create request* and fill the Candidates for the validators request form.

    C. Click *Send request*.

2) As a founder:

    A. Login under the Consensus role (Apla Consensus asbl).

    B. Navigate to *Home* > *Candidates for the validators*.

    C. Start the voting for by clicking the "play" icon by the candidate's request.

    D. Navigate to *Home* > *Votings* and click *Update votings statuses*.

    E. Click the voting name and vote for the node owner (click *Vote*).


As a result, node owner's account will be assigned the Validator role.


.. _deployment-validator-node:

Adding the validating node via voting
=====================================

1) As a founder, login under the Consensus role (Apla Consensus asbl).

2) Navigate to *Admin* > *Platform parameters* and click the cogwheel icon for the *full_nodes* parameter.

3) Specify the :ref:`node 2 parameters <deployment-config>`:

    - TCP address is ``10.10.99.2:7078``.
    - API address is ``http://10.10.99.2:7079``.
    - Key ID of the node founder is located in the ``/opt/apla/go-apla/node2/KeyID`` file.
    - Node's public key is located in the ``/opt/apla/go-apla/node2/NodePublicKey`` file.
 
4) Click *Vote*.

5) Navigate to *Home* > *Votings* and click *Update votings statuses*.

6) Click the "Voting for System param value" voting and vote for the system parameter change (Click *Accept*).

As a result, a new node will be added to the list of validating nodes.